<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meine Rezepte</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 80px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            flex: 1;
        }

        .btn-primary {
            background: #007aff;
            color: white;
        }

        .btn-secondary {
            background: #e5e5ea;
            color: #1d1d1f;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .recipe-card-mini {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .recipe-card-mini:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .recipe-card-mini h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .recipe-card-mini .meta {
            font-size: 13px;
            color: #666;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .recipe-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .tag {
            background: #007aff;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag.filter-tag {
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s, box-shadow 0.2s;
        }

        .tag.filter-tag.active {
            opacity: 1;
            box-shadow: 0 0 0 2px #005ecb;
        }

        .tag.filter-tag:hover {
            opacity: 0.8;
        }

        .view-detail, .view-library, .view-cooking {
            display: none;
        }

        .view-detail.active, .view-library.active, .view-cooking.active {
            display: block;
        }

        .recipe-detail {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .back-btn {
            background: #e5e5ea;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .recipe-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .recipe-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .recipe-tags-detail {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f5f5f7;
        }

        .notes-section {
            background: #fff9e6;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .notes-section h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: #856404;
        }

        .notes-section p {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .notes-section textarea {
            width: 100%;
            min-height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-top: 8px;
        }

        .notes-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .notes-actions button {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-save {
            background: #34c759;
            color: white;
        }

        .btn-cancel {
            background: #e5e5ea;
            color: #1d1d1f;
        }

        .portions-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .portion-btn {
            background: #007aff;
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
        }

        .portion-display {
            font-weight: 600;
            min-width: 80px;
            text-align: center;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin: 25px 0 15px 0;
        }

        .ingredients-list, .steps-list {
            list-style: none;
            padding: 0;
        }

        .ingredient-item {
            padding: 12px;
            background: #f5f5f7;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ingredient-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .ingredient-item.checked {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .step-item {
            padding: 15px;
            background: #f5f5f7;
            margin-bottom: 12px;
            border-radius: 8px;
            counter-increment: step-counter;
            position: relative;
            padding-left: 50px;
        }

        .step-item::before {
            content: counter(step-counter);
            position: absolute;
            left: 15px;
            top: 15px;
            background: #007aff;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .steps-list {
            counter-reset: step-counter;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .cooking-mode {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-height: 70vh;
        }

        .cooking-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .step-counter-display {
            font-size: 18px;
            color: #666;
            margin-bottom: 10px;
        }

        .cooking-step {
            background: #f5f5f7;
            padding: 30px;
            border-radius: 12px;
            font-size: 18px;
            line-height: 1.8;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            margin-bottom: 30px;
        }

        .cooking-controls {
            display: flex;
            gap: 10px;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .cooking-btn {
            flex: 1;
            padding: 16px;
            font-size: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
        }

        .cooking-btn.prev {
            background: #e5e5ea;
            color: #1d1d1f;
        }

        .cooking-btn.next {
            background: #007aff;
            color: white;
        }

        .cooking-btn.finish {
            background: #34c759;
            color: white;
        }

        .cooking-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .loading-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .error-state {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: #856404;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                color: black;
            }

            .container {
                max-width: 100%;
                padding: 0;
            }

            .back-btn,
            .portions-control,
            .action-buttons,
            .notes-actions {
                display: none !important;
            }

            .recipe-detail {
                box-shadow: none;
                padding: 20px;
            }

            .recipe-title {
                font-size: 24pt;
                margin-bottom: 10pt;
            }

            .recipe-meta, .recipe-tags-detail {
                border-bottom: 1pt solid #ccc;
                padding-bottom: 10pt;
                margin-bottom: 15pt;
            }

            .notes-section {
                background: #f9f9f9;
                border-left: 2pt solid #999;
                page-break-inside: avoid;
            }

            .section-title {
                font-size: 16pt;
                margin-top: 20pt;
                margin-bottom: 10pt;
                page-break-after: avoid;
            }

            .ingredient-item {
                background: white;
                border: 1pt solid #ddd;
                padding: 8pt;
                margin-bottom: 4pt;
                page-break-inside: avoid;
            }

            .ingredient-item input[type="checkbox"] {
                display: none;
            }

            .ingredient-item::before {
                content: "‚òê ";
                margin-right: 5pt;
            }

            .step-item {
                background: white;
                border: 1pt solid #ddd;
                padding: 10pt;
                padding-left: 40pt;
                margin-bottom: 8pt;
                page-break-inside: avoid;
            }

            .step-item::before {
                background: #333;
                width: 24pt;
                height: 24pt;
                left: 10pt;
                top: 10pt;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
                padding-bottom: 100px;
            }

            .recipe-title {
                font-size: 24px;
            }

            .cooking-step {
                font-size: 16px;
                padding: 20px;
                min-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Library View -->
        <div class="view-library active">
            <div class="header">
                <h1>üìö Meine Rezepte</h1>
                <p style="color: #666; font-size: 14px; margin-top: 5px;" id="recipe-count">Keine Rezepte geladen</p>
                <div class="header-actions">
                    <input type="file" id="file-input" accept=".md,.markdown,.txt" multiple style="display: none;">
                    <input type="file" id="folder-input" webkitdirectory directory multiple style="display: none;">
                    <button class="btn btn-primary" id="upload-btn">üìÅ Dateien hochladen</button>
                    <button class="btn btn-secondary" id="upload-folder-btn">üìÇ Ordner hochladen</button>
                </div>
            </div>

            <div id="filter-section" class="header" style="display: none;">
                <h3 style="font-size: 18px; margin-bottom: 10px;">üè∑Ô∏è Filter nach Tags</h3>
                <div id="filter-tags" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                <button class="btn btn-secondary" id="clear-filter-btn" style="margin-top: 10px; width: auto;">Filter zur√ºcksetzen</button>
            </div>

            <div id="error-message" class="error-state" style="display: none;"></div>
            <div id="recipe-grid" class="recipe-grid"></div>

            <div id="loading-state" class="loading-state" style="display: none;">
                <div style="font-size: 48px; margin-bottom: 15px;">‚è≥</div>
                <p>Lade Rezepte...</p>
            </div>

            <div id="empty-state" class="empty-state">
                <div class="empty-state-icon">üìñ</div>
                <h2>Keine Rezepte geladen</h2>
                <p style="margin-top: 10px;">Lade Markdown-Dateien (.md, .txt) hoch</p>
                <button class="btn btn-primary" style="margin-top: 20px;" onclick="document.getElementById('upload-btn').click()">üìÅ Rezepte hochladen</button>
            </div>
        </div>

        <!-- Detail View -->
        <div class="view-detail">
            <button class="back-btn" id="back-to-library">‚Üê Zur√ºck zur Bibliothek</button>
            <div class="recipe-detail">
                <h1 class="recipe-title" id="detail-title"></h1>
                <div class="recipe-meta" id="detail-meta"></div>
                <div class="recipe-tags-detail" id="detail-tags"></div>

                <div class="notes-section" id="notes-section">
                    <h3>üìù Notizen</h3>
                    <div id="notes-display"></div>
                    <div id="notes-edit" style="display: none;">
                        <textarea id="notes-textarea"></textarea>
                        <div class="notes-actions">
                            <button class="btn-save" id="save-notes-btn">Speichern</button>
                            <button class="btn-cancel" id="cancel-notes-btn">Abbrechen</button>
                        </div>
                    </div>
                    <button class="btn btn-secondary" id="edit-notes-btn" style="margin-top: 10px; width: auto;">Notizen bearbeiten</button>
                </div>

                <div class="portions-control">
                    <button class="portion-btn" id="decrease-portions">‚àí</button>
                    <span class="portion-display" id="portions-display"></span>
                    <button class="portion-btn" id="increase-portions">+</button>
                </div>

                <h2 class="section-title">Zutaten</h2>
                <ul class="ingredients-list" id="detail-ingredients"></ul>

                <h2 class="section-title">Zubereitung</h2>
                <ul class="steps-list" id="detail-steps"></ul>

                <div class="action-buttons">
                    <button class="btn btn-primary" id="start-cooking-btn">üë®‚Äçüç≥ Koch-Modus starten</button>
                    <button class="btn btn-secondary" id="print-btn">üñ®Ô∏è Rezept drucken</button>
                </div>
            </div>
        </div>

        <!-- Cooking Mode View -->
        <div class="view-cooking">
            <button class="back-btn" id="back-to-detail">‚Üê Zur√ºck zum Rezept</button>
            <div class="cooking-mode">
                <div class="cooking-header">
                    <h2 id="cooking-title"></h2>
                    <div class="step-counter-display" id="step-counter"></div>
                </div>

                <div class="cooking-step" id="cooking-step"></div>
            </div>

            <div class="cooking-controls">
                <button class="cooking-btn prev" id="prev-step-btn">‚Üê Zur√ºck</button>
                <button class="cooking-btn next" id="next-step-btn">Weiter ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        let recipes = {};
        let currentRecipeId = null;
        let currentStep = 0;
        let currentPortions = 6;
        let originalPortions = 6;
        let activeFilterTags = new Set();

        // Load recipes from uploaded files
        async function loadRecipesFromFiles(files) {
            const loadingState = document.getElementById('loading-state');
            const emptyState = document.getElementById('empty-state');
            const errorMessage = document.getElementById('error-message');
            const uploadBtn = document.getElementById('upload-btn');
            
            loadingState.style.display = 'block';
            emptyState.style.display = 'none';
            errorMessage.style.display = 'none';
            uploadBtn.disabled = true;

            try {
                recipes = {};
                let loadedCount = 0;

                for (const file of files) {
                    if (file.name.endsWith('.md') || file.name.endsWith('.markdown') || file.name.endsWith('.txt')) {
                        try {
                            const markdown = await file.text();
                            const recipe = parseMarkdown(markdown);
                            const id = 'recipe_' + file.name.replace(/\.(md|markdown|txt)$/, '');
                            recipes[id] = recipe;
                            loadedCount++;
                        } catch (err) {
                            console.error(`Fehler beim Laden von ${file.name}:`, err);
                        }
                    }
                }

                loadingState.style.display = 'none';
                
                if (loadedCount === 0) {
                    errorMessage.textContent = 'Keine g√ºltigen Rezept-Dateien gefunden. Bitte .md, .markdown oder .txt Dateien hochladen.';
                    errorMessage.style.display = 'block';
                }
                
                activeFilterTags.clear();
                renderLibrary();
                
            } catch (error) {
                console.error('Fehler beim Laden der Rezepte:', error);
                loadingState.style.display = 'none';
                errorMessage.textContent = `Fehler beim Laden der Rezepte: ${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                uploadBtn.disabled = false;
            }
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                loadRecipesFromFiles(files);
            }
        }

        // Handle folder upload
        function handleFolderUpload(event) {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                loadRecipesFromFiles(files);
            }
        }

        // Parse markdown
        function parseMarkdown(markdown) {
            const lines = markdown.split('\n');
            let recipe = {
                title: '',
                serves: 6,
                prepTime: '',
                cookTime: '',
                tags: [],
                notes: '',
                ingredients: [],
                steps: []
            };
            
            let currentSection = '';

            lines.forEach(line => {
                line = line.trim();
                
                if (line.startsWith('## ')) {
                    recipe.title = line.replace('## ', '').trim();
                } else if (line.startsWith('**Serves:**')) {
                    const match = line.match(/\d+/);
                    if (match) recipe.serves = parseInt(match[0]);
                } else if (line.startsWith('**Prep Time:**')) {
                    recipe.prepTime = line.replace('**Prep Time:**', '').trim();
                } else if (line.startsWith('**Cook Time:**')) {
                    recipe.cookTime = line.replace('**Cook Time:**', '').trim();
                } else if (line.startsWith('**Tags:**')) {
                    const tagString = line.replace('**Tags:**', '').trim();
                    recipe.tags = tagString.split(',').map(t => t.trim()).filter(t => t);
                } else if (line.startsWith('**Notes:**')) {
                    currentSection = 'notes';
                } else if (line.startsWith('**Ingredients:**')) {
                    currentSection = 'ingredients';
                } else if (line.startsWith('**Steps:**')) {
                    currentSection = 'steps';
                } else if (currentSection === 'notes' && line && !line.startsWith('**')) {
                    recipe.notes += (recipe.notes ? '\n' : '') + line;
                } else if (currentSection === 'ingredients' && line.startsWith('- ')) {
                    recipe.ingredients.push(line.replace('- ', '').trim());
                } else if (currentSection === 'steps' && /^\d+\./.test(line)) {
                    recipe.steps.push(line.replace(/^\d+\.\s*/, '').trim());
                }
            });

            return recipe;
        }

        // Get all unique tags
        function getAllTags() {
            const tagsSet = new Set();
            Object.values(recipes).forEach(recipe => {
                if (recipe.tags) {
                    recipe.tags.forEach(tag => tagsSet.add(tag));
                }
            });
            return Array.from(tagsSet).sort();
        }

        // Render filter tags
        function renderFilterTags() {
            const filterSection = document.getElementById('filter-section');
            const filterTagsContainer = document.getElementById('filter-tags');
            const allTags = getAllTags();
            
            if (allTags.length === 0) {
                filterSection.style.display = 'none';
                return;
            }
            
            filterSection.style.display = 'block';
            filterTagsContainer.innerHTML = allTags.map(tag => 
                `<span class="tag filter-tag ${activeFilterTags.has(tag) ? 'active' : ''}" data-tag="${tag}">${tag}</span>`
            ).join('');
            
            // Add click handlers
            filterTagsContainer.querySelectorAll('.filter-tag').forEach(tagEl => {
                tagEl.addEventListener('click', () => {
                    const tag = tagEl.dataset.tag;
                    if (activeFilterTags.has(tag)) {
                        activeFilterTags.delete(tag);
                    } else {
                        activeFilterTags.add(tag);
                    }
                    renderFilterTags();
                    renderLibrary();
                });
            });
        }

        // Scale ingredient
        function scaleIngredient(ingredient, originalServes, newServes) {
            const ratio = newServes / originalServes;
            
            const unicodeFractions = {
                '¬º': 0.25, '¬Ω': 0.5, '¬æ': 0.75,
                '‚Öê': 0.143, '‚Öë': 0.111, '‚Öí': 0.1,
                '‚Öì': 0.333, '‚Öî': 0.667,
                '‚Öï': 0.2, '‚Öñ': 0.4, '‚Öó': 0.6, '‚Öò': 0.8,
                '‚Öô': 0.167, '‚Öö': 0.833,
                '‚Öõ': 0.125, '‚Öú': 0.375, '‚Öù': 0.625, '‚Öû': 0.875
            };
            
            const decimalToUnicode = {
                0.25: '¬º', 0.5: '¬Ω', 0.75: '¬æ',
                0.333: '‚Öì', 0.667: '‚Öî',
                0.2: '‚Öï', 0.4: '‚Öñ', 0.6: '‚Öó', 0.8: '‚Öò',
                0.125: '‚Öõ', 0.375: '‚Öú', 0.625: '‚Öù', 0.875: '‚Öû'
            };
            
            let result = ingredient;
            
            result = result.replace(/(\d+)?\s*([¬º¬Ω¬æ‚Öê‚Öë‚Öí‚Öì‚Öî‚Öï‚Öñ‚Öó‚Öò‚Öô‚Öö‚Öõ‚Öú‚Öù‚Öû])/g, (match, whole, fraction) => {
                const wholeNum = whole ? parseInt(whole) : 0;
                const fracValue = unicodeFractions[fraction] || 0;
                const totalValue = wholeNum + fracValue;
                const scaled = totalValue * ratio;
                
                const wholePart = Math.floor(scaled);
                const fracPart = scaled - wholePart;
                
                for (const [decimal, unicode] of Object.entries(decimalToUnicode)) {
                    if (Math.abs(fracPart - parseFloat(decimal)) < 0.01) {
                        return wholePart > 0 ? `${wholePart}${unicode}` : unicode;
                    }
                }
                
                return scaled % 1 === 0 ? scaled.toString() : scaled.toFixed(1).replace('.', ',');
            });
            
            result = result.replace(/(\d+)\/(\d+)/g, (match, numerator, denominator) => {
                const value = parseInt(numerator) / parseInt(denominator);
                const scaled = value * ratio;
                
                for (const [decimal, unicode] of Object.entries(decimalToUnicode)) {
                    if (Math.abs(scaled - parseFloat(decimal)) < 0.01) {
                        return unicode;
                    }
                }
                
                if (Math.abs(scaled - 1) < 0.01) return '1';
                
                return scaled % 1 === 0 ? scaled.toString() : scaled.toFixed(1).replace('.', ',');
            });
            
            result = result.replace(/(\d+[.,]\d+)(?!\d)/g, (match) => {
                const num = parseFloat(match.replace(',', '.'));
                const scaled = num * ratio;
                return scaled % 1 === 0 ? scaled.toString() : scaled.toFixed(1).replace('.', ',');
            });
            
            result = result.replace(/(?<![\d.,])(\d+)(?![\d.,\/])/g, (match) => {
                const num = parseInt(match);
                const scaled = num * ratio;
                return scaled % 1 === 0 ? scaled.toString() : scaled.toFixed(1).replace('.', ',');
            });
            
            return result;
        }

// Render library
function renderLibrary() {
    const grid = document.getElementById('recipe-grid');
    const emptyState = document.getElementById('empty-state');
    const count = Object.keys(recipes).length;
    
    // Filter recipes by active tags
    let filteredRecipes = Object.entries(recipes);
    if (activeFilterTags.size > 0) {
        filteredRecipes = filteredRecipes.filter(([id, recipe]) => {
            if (!recipe.tags || recipe.tags.length === 0) return false;
            return Array.from(activeFilterTags).some(tag => recipe.tags.includes(tag));
        });
    }
    
    document.getElementById('recipe-count').textContent = 
        count === 0 ? 'Keine Rezepte geladen' : 
        count === 1 ? '1 Rezept' : `${count} Rezepte`;

    renderFilterTags();

    if (count === 0) {
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        return;
    }

    emptyState.style.display = 'none';
    
    if (filteredRecipes.length === 0) {
        grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">Keine Rezepte mit den ausgew√§hlten Tags gefunden</div>';
        return;
    }
    
    grid.innerHTML = '';

    filteredRecipes.forEach(([id, recipe]) => {
        const card = document.createElement('div');
        card.className = 'recipe-card-mini';
        
        const tagsHtml = recipe.tags && recipe.tags.length > 0 
            ? `<div class="recipe-tags">${recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>`
            : '';
        
        card.innerHTML = `
            <h3>${recipe.title}</h3>
            <div class="meta">
                ${recipe.serves ? `<span>üë• ${recipe.serves}</span>` : ''}
                ${recipe.prepTime ? `<span>‚è±Ô∏è ${recipe.prepTime}</span>` : ''}
                ${recipe.cookTime ? `<span>üî• ${recipe.cookTime}</span>` : ''}
            </div>
            ${tagsHtml}
        `;
        card.onclick = () => showDetail(id);
        grid.appendChild(card);
    });
}

        // Show detail view
        function showDetail(id) {
            currentRecipeId = id;
            const recipe = recipes[id];
            currentPortions = recipe.serves;
            originalPortions = recipe.serves;

            document.getElementById('detail-title').textContent = recipe.title;
            
            const meta = [];
            if (recipe.serves) meta.push(`<span>üë• ${recipe.serves} Portionen</span>`);
            if (recipe.prepTime) meta.push(`<span>‚è±Ô∏è ${recipe.prepTime}</span>`);
            if (recipe.cookTime) meta.push(`<span>üî• ${recipe.cookTime}</span>`);
            document.getElementById('detail-meta').innerHTML = meta.join('');

            // Display tags
            const tagsContainer = document.getElementById('detail-tags');
            if (recipe.tags && recipe.tags.length > 0) {
                tagsContainer.innerHTML = recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('');
                tagsContainer.style.display = 'flex';
            } else {
                tagsContainer.style.display = 'none';
            }

            // Display notes
            updateNotesDisplay();

            document.getElementById('portions-display').textContent = `${currentPortions} Portionen`;

            const ingredientsList = document.getElementById('detail-ingredients');
            ingredientsList.innerHTML = '';
            recipe.ingredients.forEach((ing, index) => {
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                const scaledIng = scaleIngredient(ing, originalPortions, currentPortions);
                li.innerHTML = `
                    <input type="checkbox" id="ing-${index}">
                    <label for="ing-${index}" style="flex: 1; cursor: pointer;">${scaledIng}</label>
                `;
                
                const checkbox = li.querySelector('input');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        li.classList.add('checked');
                    } else {
                        li.classList.remove('checked');
                    }
                });
                
                ingredientsList.appendChild(li);
            });

            const stepsList = document.getElementById('detail-steps');
            stepsList.innerHTML = '';
            recipe.steps.forEach((step) => {
                const li = document.createElement('li');
                li.className = 'step-item';
                li.textContent = step;
                stepsList.appendChild(li);
            });

            switchView('detail');
        }

        // Update notes display
        function updateNotesDisplay() {
            const recipe = recipes[currentRecipeId];
            const notesDisplay = document.getElementById('notes-display');
            
            if (recipe.notes && recipe.notes.trim()) {
                notesDisplay.innerHTML = `<p>${recipe.notes}</p>`;
            } else {
                notesDisplay.innerHTML = `<p style="color: #999; font-style: italic;">Noch keine Notizen vorhanden</p>`;
            }
        }

        // Edit notes
        function editNotes() {
            const recipe = recipes[currentRecipeId];
            const notesDisplay = document.getElementById('notes-display');
            const notesEdit = document.getElementById('notes-edit');
            const notesTextarea = document.getElementById('notes-textarea');
            const editBtn = document.getElementById('edit-notes-btn');
            
            notesDisplay.style.display = 'none';
            editBtn.style.display = 'none';
            notesEdit.style.display = 'block';
            notesTextarea.value = recipe.notes || '';
            notesTextarea.focus();
        }

        // Save notes
        function saveNotes() {
            const recipe = recipes[currentRecipeId];
            const notesTextarea = document.getElementById('notes-textarea');
            
            recipe.notes = notesTextarea.value;
            
            const notesDisplay = document.getElementById('notes-display');
            const notesEdit = document.getElementById('notes-edit');
            const editBtn = document.getElementById('edit-notes-btn');
            
            notesDisplay.style.display = 'block';
            editBtn.style.display = 'block';
            notesEdit.style.display = 'none';
            
            updateNotesDisplay();
        }

        // Cancel notes edit
        function cancelNotesEdit() {
            const notesDisplay = document.getElementById('notes-display');
            const notesEdit = document.getElementById('notes-edit');
            const editBtn = document.getElementById('edit-notes-btn');
            
            notesDisplay.style.display = 'block';
            editBtn.style.display = 'block';
            notesEdit.style.display = 'none';
        }

        // Start cooking mode
        function startCooking() {
            const recipe = recipes[currentRecipeId];
            currentStep = 0;
            
            document.getElementById('cooking-title').textContent = recipe.title;
            updateCookingStep();
            switchView('cooking');
        }

        // Update cooking step
        function updateCookingStep() {
            const recipe = recipes[currentRecipeId];
            const totalSteps = recipe.steps.length;
            
            document.getElementById('step-counter').textContent = 
                `Schritt ${currentStep + 1} von ${totalSteps}`;
            
            document.getElementById('cooking-step').textContent = recipe.steps[currentStep];

            document.getElementById('prev-step-btn').disabled = currentStep === 0;
            
            const nextBtn = document.getElementById('next-step-btn');
            if (currentStep === totalSteps - 1) {
                nextBtn.textContent = '‚úì Fertig';
                nextBtn.className = 'cooking-btn finish';
            } else {
                nextBtn.textContent = 'Weiter ‚Üí';
                nextBtn.className = 'cooking-btn next';
            }
        }

        // Switch views
        function switchView(view) {
            document.querySelectorAll('.view-library, .view-detail, .view-cooking').forEach(v => {
                v.classList.remove('active');
            });
            document.querySelector(`.view-${view}`).classList.add('active');
        }

        // Update portions
        function updatePortions() {
            const recipe = recipes[currentRecipeId];
            
            document.getElementById('portions-display').textContent = `${currentPortions} Portionen`;
            
            const ingredientsList = document.getElementById('detail-ingredients');
            const checkboxStates = [];
            
            ingredientsList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                checkboxStates.push(cb.checked);
            });
            
            ingredientsList.innerHTML = '';
            recipe.ingredients.forEach((ing, index) => {
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                const scaledIng = scaleIngredient(ing, originalPortions, currentPortions);
                li.innerHTML = `
                    <input type="checkbox" id="ing-${index}" ${checkboxStates[index] ? 'checked' : ''}>
                    <label for="ing-${index}" style="flex: 1; cursor: pointer;">${scaledIng}</label>
                `;
                
                if (checkboxStates[index]) {
                    li.classList.add('checked');
                }
                
                const checkbox = li.querySelector('input');
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        li.classList.add('checked');
                    } else {
                        li.classList.remove('checked');
                    }
                });
                
                ingredientsList.appendChild(li);
            });
        }

        // Event listeners
        document.getElementById('upload-btn').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        document.getElementById('upload-folder-btn').addEventListener('click', () => {
            document.getElementById('folder-input').click();
        });

        document.getElementById('file-input').addEventListener('change', handleFileUpload);
        document.getElementById('folder-input').addEventListener('change', handleFolderUpload);

        document.getElementById('back-to-library').addEventListener('click', () => {
            switchView('library');
        });

        document.getElementById('decrease-portions').addEventListener('click', function() {
            if (currentPortions > 1) {
                currentPortions--;
                updatePortions();
            }
        });

        document.getElementById('increase-portions').addEventListener('click', function() {
            currentPortions++;
            updatePortions();
        });

        document.getElementById('start-cooking-btn').addEventListener('click', startCooking);

        document.getElementById('print-btn').addEventListener('click', function() {
            window.print();
        });

        document.getElementById('edit-notes-btn').addEventListener('click', editNotes);
        document.getElementById('save-notes-btn').addEventListener('click', saveNotes);
        document.getElementById('cancel-notes-btn').addEventListener('click', cancelNotesEdit);

        document.getElementById('back-to-detail').addEventListener('click', () => {
            showDetail(currentRecipeId);
        });

        document.getElementById('prev-step-btn').addEventListener('click', function() {
            if (currentStep > 0) {
                currentStep--;
                updateCookingStep();
            }
        });

        document.getElementById('next-step-btn').addEventListener('click', function() {
            const recipe = recipes[currentRecipeId];
            if (currentStep < recipe.steps.length - 1) {
                currentStep++;
                updateCookingStep();
            } else {
                showDetail(currentRecipeId);
            }
        });
    </script>
</body>
</html>
